<template>
  <div class="log-container">
    <!-- <div class="title">Logcat</div> -->
    <div class="tool-bar">
      <el-select v-model="deviceSelect" size="mini" placeholder="指定设备" style="width: 150px;">
        <el-option label="全部设备" value />
        <el-option
          v-for="item in $store.state.device.list.filter(i => i.is_online)"
          :key="item.device_id"
          :label="item.name"
          :value="item.device_id"
        />
      </el-select>
      <el-select
        v-model="logLevel"
        size="mini"
        placeholder="日志级别"
        style="width: 100px; margin-left: 10px;"
      >
        <el-option label="Verbose" value="" />
        <el-option label="Debug" value="Debug" />
        <el-option label="Info" value="Info" />
        <el-option label="Warn" value="Warn" />
        <el-option label="Error" value="Error" />
      </el-select>
      <el-input
        v-model="logFilter"
        placeholder="请输入内容"
        size="mini"
        prefix-icon="el-icon-search"
        style="width: 200px; margin-left: 10px;"
      />
      <div class="actions">
        <el-button
          v-if="showRun"
          icon="el-icon-caret-right"
          plain
          circle
          size="mini"
          @click="runScript"
        />
        <el-button class="right mr10" icon="el-icon-circle-close" plain circle size="mini" @click="clearConsole" />
      </div>
    </div>
    <div
      ref="logScroller"
      v-auto-height:maxHeight="-10"
      class="log-scroller"
      :style="{ 'max-height': maxHeight + 'px' }"
    >
      <div v-for="(item, index) in showLogs" :key="index">{{ item.log }}</div>
    </div>
  </div>
</template>

<script>
import { mapGetters } from "vuex";
import request from "@/utils/request";
import WebSocketManager from "@/WebSocketClientManager";

export default {
  name: "DeviceLog",
  props: ['showRun'],
  data() {
    return {
      maxHeight: 500,
      messageListener: null,
      deviceSelect: "",
      logLevel: "Verbose",
      logFilter: "",
      logs: []
    };
  },
  computed: {
    ...mapGetters(["name"]),
    showLogs() {
      if (this.deviceSelect) {
        //
      }
      return this.logs;
    },
  },
  created() {
    this.messageListener = message => {
      if (message.type === "log") {
        this.logs.push(message.data);
        this.$refs.logScroller.scrollTop = this.$refs.logScroller.scrollHeight;
      }
    };
    WebSocketManager.getInstance().addMessageListener(this.messageListener);
  },
  destroyed() {
    WebSocketManager.getInstance().removeMessageListener(this.messageListener);
  },
  methods: {
    clearConsole() {
      this.logs = [];
    },
    runScript() {
      this.$emit('run', {
        devices: this.device_id
      });
    }
  }
};
</script>

<style lang="scss" scoped>
.log-container {
  color: #303030;
}
.title {
  background-color: #eeeeee;
  border: 1px solid #5555553b;
  padding: 5px 10px;
}
.tool-bar {
  background-color: #f2f2f2;
  display: flex;
  padding: 10px;
}
.tool-bar .actions {
  flex-grow: 1;
  margin-left: 25px;
  padding-right: 15px;
}
.log-scroller {
  overflow: auto;
  padding: 5px 5px 1.5em 10px;
}
</style>
